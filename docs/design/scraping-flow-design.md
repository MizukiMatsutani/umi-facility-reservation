# ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ•ãƒ­ãƒ¼è¨­è¨ˆæ›¸ï¼ˆæœ€æ–°ç‰ˆï¼‰

## æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|-----------|---------|
| 2025-12-08 | 2.6 | ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¨ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã‚’è¿½åŠ  |
| 2025-12-08 | 2.5 | Step 1ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆAJAXå¾…æ©Ÿ500msã€domcontentloadedä½¿ç”¨ï¼‰ |
| 2025-12-07 | 2.4 | è¤‡æ•°æ—¥é¸æŠæ™‚ã®æ—¥ä»˜ã”ã¨ãƒ«ãƒ¼ãƒ—å‡¦ç†ã€ã€Œï¼ã€é¸æŠå¯¾å¿œã€æˆ»ã‚‹ãƒœã‚¿ãƒ³å‡¦ç†ã‚’è¿½åŠ  |
| 2025-12-07 | 2.3 | æ¤œç´¢åˆ¶é™ã‚’7æ—¥é–“ã«å¤‰æ›´ã€è¡¨ç¤ºæœŸé–“1ãƒ¶æœˆè¨­å®šã®è¿½åŠ  |
| 2025-12-07 | 2.2 | ã‚³ãƒ¼ãƒˆå˜ä½ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ã®è¿½åŠ ã€æ™‚é–“å¸¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®å‰Šé™¤ |
| 2025-12-06 | 2.1 | ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã¨Step 4ã®ãƒšãƒ¼ã‚¸æ§‹é€ ã‚’ä¿®æ­£ |
| 2025-12-06 | 2.0 | å®Œå…¨ãªèª¿æŸ»çµæœã‚’åŸºã«å…¨é¢æ”¹è¨‚ |
| 2025-12-06 | 1.0 | åˆç‰ˆä½œæˆ |

## æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€å®‡ç¾ç”ºæ–½è¨­äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«æ–½è¨­ã®ç©ºãçŠ¶æ³ã‚’å–å¾—ã™ã‚‹ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ•ãƒ­ãƒ¼ã®è¨­è¨ˆã‚’å®šç¾©ã—ã¾ã™ã€‚

## å‰ææ¡ä»¶

- å¯¾è±¡ã‚¹ãƒãƒ¼ãƒ„: ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«ã€ãƒŸãƒ‹ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«
- å¯¾è±¡æ–½è¨­: æ¤œç´¢çµæœã«è¡¨ç¤ºã•ã‚Œã‚‹å…¨æ–½è¨­ï¼ˆç´„10æ–½è¨­ï¼‰
- **æœ€å¤§æ—¥æ•°: 7æ—¥ã¾ã§**ï¼ˆæœ¬ã‚·ã‚¹ãƒ†ãƒ ã®åˆ¶é™ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã¸ã®è² è·ã‚’è€ƒæ…®ï¼‰
  - ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã¯æœ€å¤§10æ—¥ã¾ã§é¸æŠå¯èƒ½
  - æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã¯7æ—¥é–“ã«åˆ¶é™ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã¸ã®è² è·ã‚’è»½æ¸›
- æ™‚é–“å¸¯: 8:30ã€œ22:00ï¼ˆ30åˆ†åˆ»ã¿ï¼‰

---

## å…¨ä½“ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[é–‹å§‹] --> B[Step 1: æ¤œç´¢ãƒšãƒ¼ã‚¸]
    B --> C[Step 2: æ–½è¨­æ¤œç´¢ãƒšãƒ¼ã‚¸]
    C --> D[Step 3: æ–½è¨­åˆ¥ç©ºãçŠ¶æ³ãƒšãƒ¼ã‚¸]
    D --> E[Step 4: æ™‚é–“å¸¯åˆ¥ç©ºãçŠ¶æ³ãƒšãƒ¼ã‚¸]
    E --> F[ãƒ‡ãƒ¼ã‚¿è§£æ]
    F --> G[çµ‚äº†]
```

---

## Step 1: æ¤œç´¢ãƒšãƒ¼ã‚¸ (WgR_ModeSelect)

### URL
`https://www.11489.jp/Umi/web/Home/WgR_ModeSelect`

### æ“ä½œæ‰‹é †

1. **å±‹å†…ã‚¹ãƒãƒ¼ãƒ„ã‚’é¸æŠ**
   ```typescript
   const radio = document.querySelector('#radioPurposeLarge02') as HTMLInputElement;
   radio.checked = true;
   radio.click();
   ```

2. **AJAXå®Œäº†ã‚’å¾…æ©Ÿ**ï¼ˆæœ€é©åŒ–: 2000ms â†’ 500msï¼‰
   ```typescript
   await page.waitForSelector('#checkPurposeMiddle505', { timeout: 10000 });
   await new Promise(resolve => setTimeout(resolve, 500));
   ```

3. **ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«ã¨ãƒŸãƒ‹ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«ã‚’é¸æŠ**
   ```typescript
   const checkbox505 = document.querySelector('#checkPurposeMiddle505') as HTMLInputElement;
   const checkbox510 = document.querySelector('#checkPurposeMiddle510') as HTMLInputElement;

   checkbox505.checked = true;
   checkbox510.checked = true;
   ```

4. **æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯**
   ```typescript
   const btn = document.querySelector('#btnSearchViaPurpose') as HTMLElement;
   btn.click();
   ```

5. **ãƒšãƒ¼ã‚¸é·ç§»ã‚’å¾…æ©Ÿ**ï¼ˆæœ€é©åŒ–: networkidle0 â†’ domcontentloadedï¼‰
   ```typescript
   await page.waitForNavigation({ waitUntil: 'domcontentloaded', timeout: 30000 });
   ```

### ã‚»ãƒ¬ã‚¯ã‚¿ä¸€è¦§

| è¦ç´  | ã‚»ãƒ¬ã‚¯ã‚¿ | èª¬æ˜ |
|------|---------|------|
| å±‹å†…ã‚¹ãƒãƒ¼ãƒ„ | `#radioPurposeLarge02` | ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ |
| ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ« | `#checkPurposeMiddle505` | ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ |
| ãƒŸãƒ‹ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ« | `#checkPurposeMiddle510` | ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ |
| æ¤œç´¢ãƒœã‚¿ãƒ³ | `#btnSearchViaPurpose` | ãƒœã‚¿ãƒ³ |

---

## Step 2: æ–½è¨­æ¤œç´¢ãƒšãƒ¼ã‚¸ (WgR_ShisetsuKensaku)

### URL
`https://www.11489.jp/Umi/web/Yoyaku/WgR_ShisetsuKensaku`

### æ“ä½œæ‰‹é †

1. **å…¨æ–½è¨­ã‚’é¸æŠ**ï¼ˆlabelã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹æ–¹æ³•ï¼‰
   ```typescript
   const checkboxes = document.querySelectorAll(
     '.shisetsu input[type="checkbox"][name="checkShisetsu"]'
   ) as NodeListOf<HTMLInputElement>;

   checkboxes.forEach(checkbox => {
     const label = document.querySelector(`label[for="${checkbox.id}"]`) as HTMLElement;
     if (label) {
       label.click();
     }
   });
   ```

   **é‡è¦**: `checkbox.checked = true; checkbox.click();` ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚å¿…ãš `label.click()` ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

2. **é¸æŠçŠ¶æ…‹ã®ç¢ºèª**
   ```typescript
   await new Promise(resolve => setTimeout(resolve, 500));

   const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
   console.log(`é¸æŠæ¸ˆã¿æ–½è¨­æ•°: ${checkedCount}`);
   ```

3. **ã€Œæ¬¡ã¸é€²ã‚€ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯**
   ```typescript
   await page.click('.navbar .next > a');
   await page.waitForNavigation({ waitUntil: 'networkidle0', timeout: 10000 });
   ```

### ã‚»ãƒ¬ã‚¯ã‚¿ä¸€è¦§

| è¦ç´  | ã‚»ãƒ¬ã‚¯ã‚¿ | èª¬æ˜ |
|------|---------|------|
| æ–½è¨­ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ | `.shisetsu input[type="checkbox"][name="checkShisetsu"]` | å…¨æ–½è¨­ |
| æ–½è¨­ãƒ©ãƒ™ãƒ« | `label[for="checkShisetsu${facilityId}"]` | ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«å¯¾å¿œ |
| æ¬¡ã¸é€²ã‚€ãƒœã‚¿ãƒ³ | `.navbar .next > a` ã¾ãŸã¯ `#btnNext` | é·ç§»ãƒœã‚¿ãƒ³ |

### å–å¾—ãƒ‡ãƒ¼ã‚¿

```typescript
interface Facility {
  id: string;        // ä¾‹: "341007"
  name: string;      // ä¾‹: "å®‡ç¾å‹¤åŠ´è€…ä½“è‚²ã‚»ãƒ³ã‚¿ãƒ¼"
  checkbox: HTMLInputElement;
}
```

---

## Step 3: æ–½è¨­åˆ¥ç©ºãçŠ¶æ³ãƒšãƒ¼ã‚¸ (WgR_ShisetsubetsuAkiJoukyou)

### URL
`https://www.11489.jp/Umi/web/Yoyaku/WgR_ShisetsubetsuAkiJoukyou`

### ãƒšãƒ¼ã‚¸æ§‹é€ 

- å„æ–½è¨­ã”ã¨ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªæ—¥ä»˜ãƒªã‚¹ãƒˆ
- æ—¥ä»˜ã‚»ãƒ«ã«ç©ºãçŠ¶æ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆâ—‹â–³Ã—ï¼ä¼‘ï¼‰

### æ“ä½œæ‰‹é †

1. **è¡¨ç¤ºæœŸé–“ã‚’1ãƒ¶æœˆã«è¨­å®š**ï¼ˆæ¤œç´¢æ—¥ã®æœ€åˆã®æ—¥ã‹ã‚‰2é€±é–“ä»¥ä¸Šå…ˆã®æ—¥ä»˜ã‚’å–å¾—ã™ã‚‹ãŸã‚ï¼‰

   **ç†ç”±**: æ–½è¨­åˆ¥ç©ºãçŠ¶æ³ãƒšãƒ¼ã‚¸ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å½“æ—¥ã‹ã‚‰2é€±é–“ã—ã‹è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§å½“æ—¥ã‹ã‚‰2é€±é–“ä»¥ä¸Šã‚ã¨ã‚’é¸æŠã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãŒå–ã‚Œã¾ã›ã‚“ã€‚ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¯¾è±¡ã‚µã‚¤ãƒˆã§ã¯ã€è¡¨ç¤ºé–‹å§‹æ—¥ï¼ˆ#dpStartDateï¼‰ã¨è¡¨ç¤ºæœŸé–“ï¼ˆ#radioPeriod1monthï¼‰ã‚’è¨­å®šã—ã€æ¤œç´¢ãƒœã‚¿ãƒ³ï¼ˆ#btnHyojiï¼‰ã§ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ã€è¡¨ç¤ºæœŸé–“ã‚’1ãƒ¶æœˆã«æ‹¡å¼µã§ãã¾ã™ã€‚

   ```typescript
   async function setDisplayPeriodToOneMonth(page: Page, firstDate: Date) {
     // æ¤œç´¢æ—¥ã®æœ€åˆã®æ—¥ã‚’è¨­å®š
     const startDateStr = format(firstDate, 'yyyy/MM/dd');

     await page.evaluate((dateStr) => {
       const startDateInput = document.querySelector('#dpStartDate') as HTMLInputElement;
       if (startDateInput) {
         startDateInput.value = dateStr;
       }
     }, startDateStr);

     // è¡¨ç¤ºæœŸé–“ã‚’1ãƒ¶æœˆã«è¨­å®š
     await page.evaluate(() => {
       const radio1Month = document.querySelector('#radioPeriod1month') as HTMLInputElement;
       if (radio1Month) {
         radio1Month.checked = true;
       }
     });

     // è¡¨ç¤ºãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
     await page.click('#btnHyoji');
     await page.waitForNavigation({ waitUntil: 'networkidle0', timeout: 10000 });
   }
   ```

2. **æ—¢å­˜ã®é¸æŠã‚’ã‚¯ãƒªã‚¢**ï¼ˆæˆ»ã‚‹ãƒœã‚¿ãƒ³ã§æˆ»ã£ãŸå ´åˆã«å‰å›ã®é¸æŠãŒæ®‹ã£ã¦ã„ã‚‹ãŸã‚ï¼‰

   ```typescript
   const checkboxes = document.querySelectorAll(
     'input[type="checkbox"][name="checkdate"]'
   ) as NodeListOf<HTMLInputElement>;

   checkboxes.forEach(checkbox => {
     // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã€labelã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è§£é™¤
     if (checkbox.checked) {
       const label = document.querySelector(`label[for="${checkbox.id}"]`) as HTMLElement;
       if (label) {
         label.click();
       }
     }
   });

   // DOMæ›´æ–°ã‚’å¾…æ©Ÿ
   await new Promise(resolve => setTimeout(resolve, 500));
   ```

3. **å¯¾è±¡æ—¥ä»˜ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’é¸æŠ**

   ```typescript
   function selectDates(targetDates: Date[]) {
     const dateStrings = targetDates.map(date =>
       format(date, 'yyyyMMdd') // ä¾‹: "20251211"
     );

     const checkboxes = document.querySelectorAll(
       'input[type="checkbox"][name="checkdate"]'
     ) as NodeListOf<HTMLInputElement>;

     checkboxes.forEach(checkbox => {
       // valueã®æœ€åˆã®8æ–‡å­—ãŒæ—¥ä»˜ï¼ˆYYYYMMDDï¼‰
       const checkboxDate = checkbox.value.substring(0, 8);

       if (dateStrings.includes(checkboxDate)) {
         // ç©ºãçŠ¶æ³ã‚’ç¢ºèª
         const label = document.querySelector(`label[for="${checkbox.id}"]`);
         const status = label?.textContent?.trim();

         // â—‹ã€â–³ã€ï¼ã‚’é¸æŠï¼ˆç©ºãã‚ã‚Šã€ä¸€éƒ¨ç©ºãã€å½“æ—¥ãªã©ï¼‰
         if (status === 'â—‹' || status === 'â–³' || status === 'ï¼') {
           // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ã‚¯ãƒªãƒƒã‚¯
           if (!checkbox.checked) {
             label.click();
           }
         }
       }
     });
   }
   ```

4. **é¸æŠæ•°ã®åˆ¶é™ãƒã‚§ãƒƒã‚¯**
   ```typescript
   const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

   if (selectedCount > 7) {
     throw new Error('æœ€å¤§7æ—¥ã¾ã§é¸æŠå¯èƒ½ã§ã™ï¼ˆæœ¬ã‚·ã‚¹ãƒ†ãƒ ã®åˆ¶é™ï¼‰');
   }
   ```

5. **ã€Œæ¬¡ã¸é€²ã‚€ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯**
   ```typescript
   await page.click('.navbar .next > a');
   await page.waitForNavigation({ waitUntil: 'networkidle0', timeout: 10000 });
   ```

### æ—¥ä»˜valueã®å½¢å¼

```
value="2025121100701   0"
       ^^^^^^^^ ^^^^^ ^^^
       æ—¥ä»˜     æ–½è¨­  ä¸æ˜
       YYYYMMDD ã‚³ãƒ¼ãƒ‰
```

### ç©ºãçŠ¶æ³ãƒ©ãƒ™ãƒ«

| ãƒ©ãƒ™ãƒ« | æ„å‘³ | é¸æŠå¯å¦ | å‡¦ç† |
|--------|------|----------|------|
| `â—‹` | ç©ºãã‚ã‚Š | âœ… | é¸æŠã™ã‚‹ |
| `â–³` | ä¸€éƒ¨ç©ºã | âœ… | é¸æŠã™ã‚‹ |
| `ï¼` | å½“æ—¥ãªã© | âœ… | **é¸æŠã™ã‚‹**ï¼ˆå½“æ—¥ã®å ´åˆã«è¡¨ç¤ºã•ã‚Œã‚‹ãŒã€é¸æŠå¯èƒ½ã§ç©ºãçŠ¶æ³ãŒè¦‹ã‚‰ã‚Œã‚‹ï¼‰ |
| `Ã—` | ç©ºããªã— | âŒ | é¸æŠã—ãªã„ï¼ˆå…¨æ™‚é–“å¸¯äºˆç´„æ¸ˆã¿ï¼‰ |
| `ä¼‘` | ä¼‘é¤¨æ—¥ | âŒ | é¸æŠã§ããªã„ï¼ˆdisabledï¼‰ |

### ã‚»ãƒ¬ã‚¯ã‚¿ä¸€è¦§

| è¦ç´  | ã‚»ãƒ¬ã‚¯ã‚¿ | èª¬æ˜ |
|------|---------|------|
| ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå…¨æ–½è¨­åˆ†ï¼‰ | `.item .calendar` | å„æ–½è¨­ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ |
| æ–½è¨­å | `.item h3` | æ–½è¨­åè¡¨ç¤º |
| æ—¥ä»˜ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ | `input[type="checkbox"][name="checkdate"]` | å…¨æ—¥ä»˜ã‚»ãƒ« |
| æ—¥ä»˜ãƒ©ãƒ™ãƒ« | `label[for="${checkboxId}"]` | ç©ºãçŠ¶æ³è¡¨ç¤º |
| æ¬¡ã¸é€²ã‚€ãƒœã‚¿ãƒ³ | `.navbar .next > a` | é·ç§»ãƒœã‚¿ãƒ³ |

---

## Step 4: æ™‚é–“å¸¯åˆ¥ç©ºãçŠ¶æ³ãƒšãƒ¼ã‚¸ (WgR_JikantaibetsuAkiJoukyou)

### URL
`https://www.11489.jp/Umi/web/Yoyaku/WgR_JikantaibetsuAkiJoukyou`

### ãƒšãƒ¼ã‚¸æ§‹é€ 

**é‡è¦**: å½“åˆã®æƒ³å®šã¨ã¯ç•°ãªã‚‹æ§‹é€ ã§ã—ãŸã€‚

- å„`.item`è¦ç´ ãŒ1ã¤ã®æ–½è¨­ã‚’è¡¨ã™
- å„æ–½è¨­å†…ã«**è¤‡æ•°ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«**ãŒå­˜åœ¨
  - å„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã¯**1ã¤ã®æ—¥ä»˜**ã®æ™‚é–“å¸¯ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
  - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ`th.shisetsu`ï¼‰ã«æ—¥ä»˜ãŒå«ã¾ã‚Œã‚‹ï¼ˆä¾‹: "2025å¹´12æœˆ11æ—¥(æ°´)"ï¼‰
- æ™‚é–“å¸¯ã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼ˆ8:30ï½22:00ã€30åˆ†åˆ»ã¿ï¼‰
- tbody ã®å„è¡ŒãŒ1ã¤ã®ã‚³ãƒ¼ãƒˆï¼ˆä¾‹: "ä½“è‚²é¤¨ å…¨é¢"ã€"ä½“è‚²é¤¨ ã‚¹ãƒ†ãƒ¼ã‚¸å´"ï¼‰

### HTMLæ§‹é€ ä¾‹

```html
<div class="item">
  <h3>å®‡ç¾å‹¤åŠ´è€…ä½“è‚²ã‚»ãƒ³ã‚¿ãƒ¼</h3>

  <h4>ä½“è‚²é¤¨</h4>
  <table class="calendar">
    <thead>
      <tr>
        <th class="shisetsu">2025å¹´12æœˆ11æ—¥(æ°´)</th>
        <th class="teiin">å®šå“¡</th>
        <th>8:30ï½9:00</th>
        <th>9:00ï½9:30</th>
        <!-- ... -->
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="shisetsu">ä½“è‚²é¤¨ å…¨é¢</td>
        <td>100</td>
        <td><label>â—‹</label></td>
        <td><label>Ã—</label></td>
        <!-- ... -->
      </tr>
    </tbody>
  </table>
</div>
```

### ãƒ‡ãƒ¼ã‚¿å–å¾—æ‰‹é †

1. **å„æ–½è¨­ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å–å¾—**
   ```typescript
   const items = document.querySelectorAll('.item');

   items.forEach(item => {
     const facilityName = item.querySelector('h3')?.textContent?.trim();
     const calendars = item.querySelectorAll('.calendar');

     // å„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒ1æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿
     calendars.forEach(calendar => {
       // æ—¥ä»˜ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰å–å¾—
       const dateHeader = calendar.querySelector('thead th.shisetsu');
       const dateText = dateHeader?.textContent?.trim(); // "2025å¹´12æœˆ11æ—¥(æ°´)"

       // æ—¥ä»˜ã‚’æŠ½å‡º
       const dateMatch = dateText.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
       const [_, year, month, day] = dateMatch;
       const dateStr = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

       // ... æ™‚é–“å¸¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
     });
   });
   ```

2. **æ™‚é–“å¸¯ã¨ã‚³ãƒ¼ãƒˆå˜ä½ã®ãƒ‡ãƒ¼ã‚¿å–å¾—**
   ```typescript
   // æ™‚é–“å¸¯ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å–å¾—ï¼ˆ"8:30ï½9:00"å½¢å¼ï¼‰
   const timeHeaders = Array.from(
     calendar.querySelectorAll('thead th')
   ).slice(2); // æœ€åˆã®2ã¤ã¯ã€Œæ—¥ä»˜ã€ã¨ã€Œå®šå“¡ã€

   // ã‚³ãƒ¼ãƒˆè¡Œã‚’å–å¾—
   const rows = Array.from(calendar.querySelectorAll('tbody tr'));

   // ã‚³ãƒ¼ãƒˆåã‚’æŠ½å‡º
   const courtNames = rows.map(row => {
     const firstCell = row.querySelector('td.shisetsu');
     return firstCell?.textContent?.trim() || '';
   });

   // å„æ™‚é–“å¸¯ã®ã‚³ãƒ¼ãƒˆåˆ¥ç©ºãçŠ¶æ³ã‚’å–å¾—
   const slots = timeHeaders.map((th, timeIndex) => {
     const timeText = th.textContent?.trim(); // "8:30ï½9:00"
     const time = timeText.replace('ï½', '-').replace(/\s/g, ''); // "8:30-9:00"

     // å„ã‚³ãƒ¼ãƒˆã®ç©ºãçŠ¶æ³ã‚’å–å¾—
     const courts = rows.map((row, rowIndex) => {
       const cells = Array.from(row.querySelectorAll('td'));
       const cell = cells[timeIndex + 2]; // æœ€åˆã®2ã¤ã¯æ–½è¨­åã¨å®šå“¡
       const label = cell?.querySelector('label');
       const status = label?.textContent?.trim();

       return {
         name: courtNames[rowIndex],
         available: status === 'â—‹',
       };
     });

     // ç©ºãã®ã‚ã‚‹ã‚³ãƒ¼ãƒˆæ•°ã‚’é›†è¨ˆ
     const availableCourts = courts.filter(c => c.available).length;
     const totalCourts = courts.length;

     // AvailabilityStatusã‚’è¨ˆç®—
     let availabilityStatus: 'all-available' | 'partially-available' | 'unavailable';
     if (availableCourts === 0) {
       availabilityStatus = 'unavailable';
     } else if (availableCourts === totalCourts) {
       availabilityStatus = 'all-available';
     } else {
       availabilityStatus = 'partially-available';
     }

     return {
       time,
       available: availableCourts > 0,
       status: availabilityStatus,
       courts,
     };
   });
   ```

### ã‚»ãƒ¬ã‚¯ã‚¿ä¸€è¦§

| è¦ç´  | ã‚»ãƒ¬ã‚¯ã‚¿ | èª¬æ˜ |
|------|---------|------|
| ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå…¨æ–½è¨­åˆ†ï¼‰ | `.item .calendar` | å„æ–½è¨­ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ |
| æ–½è¨­å | `.item h3` | æ–½è¨­åè¡¨ç¤º |
| ã‚³ãƒ¼ãƒˆè¡Œ | `.calendar tr` | å„ã‚³ãƒ¼ãƒˆ |
| ã‚³ãƒ¼ãƒˆå | `.calendar tr .shisetsu` | ã‚³ãƒ¼ãƒˆã®åå‰ |
| æ™‚é–“å¸¯ã‚»ãƒ« | `.calendar tr td label` | å„æ™‚é–“å¸¯ã®ç©ºãçŠ¶æ³ |

### å–å¾—ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```typescript
interface FacilityAvailability {
  facility: {
    id: string;
    name: string;
    type: 'basketball' | 'mini-basketball';
  };
  availability: AvailabilityData[];
}

interface AvailabilityData {
  date: Date;           // å¯¾è±¡æ—¥ä»˜
  slots: TimeSlot[];    // æ™‚é–“å¸¯ã”ã¨ã®ç©ºãçŠ¶æ³
}

interface CourtStatus {
  name: string;         // ã‚³ãƒ¼ãƒˆåï¼ˆ"å…¨é¢", "å€‰åº«å´", "å£å´"ãªã©ï¼‰
  available: boolean;   // true = ç©ºã, false = ç©ºã„ã¦ã„ãªã„
}

type AvailabilityStatus = 'all-available' | 'partially-available' | 'unavailable';

interface TimeSlot {
  time: string;                           // æ™‚åˆ»ï¼ˆ"8:30", "9:00"ãªã©ï¼‰
  available: boolean;                     // true = ã„ãšã‚Œã‹ã®ã‚³ãƒ¼ãƒˆãŒç©ºã
  status: AvailabilityStatus;             // ç©ºãçŠ¶æ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  courts: readonly CourtStatus[];         // ã‚³ãƒ¼ãƒˆåˆ¥ã®ç©ºãçŠ¶æ³
}
```

---

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 1. ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è‡ªå‹•å—ã‘å…¥ã‚Œ

```typescript
page.on('dialog', async dialog => {
  console.log('ãƒ€ã‚¤ã‚¢ãƒ­ã‚°:', dialog.message());
  await dialog.accept();
});
```

### 2. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†

```typescript
try {
  await page.waitForNavigation({
    waitUntil: 'networkidle0',
    timeout: 10000
  });
} catch (error) {
  throw new Error(`ãƒšãƒ¼ã‚¸é·ç§»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ${error.message}`);
}
```

### 3. è¦ç´ ã®å­˜åœ¨ç¢ºèª

```typescript
const element = await page.waitForSelector('#btnNext', {
  timeout: 5000
}).catch(() => null);

if (!element) {
  throw new Error('ã€Œæ¬¡ã¸é€²ã‚€ã€ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
}
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆv2.6ã§è¿½åŠ ï¼‰

**ç›®çš„**: ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†åˆ©ç”¨ã—ã€åˆæœŸåŒ–æ™‚é–“ã‚’å‰Šæ¸›

**å®Ÿè£…**: `src/lib/scraper/BrowserManager.ts`

**ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹ç®¡ç†**:
```typescript
class BrowserManager {
  private static instance: BrowserManager;
  private browserInstance: BrowserInstance = {
    browser: null,
    state: 'uninitialized',
    lastUsed: Date.now(),
  };

  static getInstance(): BrowserManager {
    if (!BrowserManager.instance) {
      BrowserManager.instance = new BrowserManager();
    }
    return BrowserManager.instance;
  }
}

export const browserManager = BrowserManager.getInstance();
```

**ä¸»ãªæ©Ÿèƒ½**:

1. **çŠ¶æ…‹ç®¡ç†**ï¼ˆ4ã¤ã®çŠ¶æ…‹ï¼‰:
   - `uninitialized`: åˆæœŸåŒ–å‰
   - `initializing`: åˆæœŸåŒ–ä¸­ï¼ˆä»–ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å¾…æ©Ÿï¼‰
   - `ready`: åˆ©ç”¨å¯èƒ½
   - `error`: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼ˆå†åˆæœŸåŒ–ãŒå¿…è¦ï¼‰

2. **ãƒ–ãƒ©ã‚¦ã‚¶ã®å†åˆ©ç”¨**:
   ```typescript
   async initializeBrowser(): Promise<any> {
     // æ—¢ã«readyçŠ¶æ…‹ãªã‚‰æ—¢å­˜ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’è¿”ã™
     if (this.browserInstance.state === 'ready' && this.browserInstance.browser) {
       console.log('â™»ï¸  æ—¢å­˜ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†åˆ©ç”¨');
       this.browserInstance.lastUsed = Date.now();
       this.resetTimeout();
       return this.browserInstance.browser;
     }
     // ... åˆæœŸåŒ–å‡¦ç†
   }
   ```

3. **è‡ªå‹•ãƒªã‚«ãƒãƒªãƒ¼**:
   ```typescript
   this.browserInstance.browser.on('disconnected', () => {
     console.log('âš ï¸  ãƒ–ãƒ©ã‚¦ã‚¶ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚æ¬¡å›ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«å†èµ·å‹•ã—ã¾ã™ã€‚');
     this.browserInstance.state = 'uninitialized';
     this.browserInstance.browser = null;
   });
   ```

4. **10åˆ†é–“ã®è‡ªå‹•ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**:
   ```typescript
   private readonly BROWSER_TIMEOUT = 10 * 60 * 1000;

   private resetTimeout(): void {
     if (this.timeoutId) {
       clearTimeout(this.timeoutId);
     }
     this.timeoutId = setTimeout(async () => {
       const idleTime = Date.now() - this.browserInstance.lastUsed;
       if (idleTime >= this.BROWSER_TIMEOUT) {
         console.log('â° ãƒ–ãƒ©ã‚¦ã‚¶ãŒ10åˆ†é–“ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™');
         await this.closeBrowser();
       }
     }, this.BROWSER_TIMEOUT);
   }
   ```

**DirectApiClientã¨FacilityScraperã®çµ±åˆ**:
```typescript
// DirectApiClient.ts
import { browserManager } from './BrowserManager';

async initBrowser(): Promise<void> {
  this.page = await browserManager.createPage();
}

async closeBrowser(): Promise<void> {
  if (this.page) {
    await this.page.close(); // ãƒšãƒ¼ã‚¸ã®ã¿ã‚¯ãƒ­ãƒ¼ã‚º
    this.page = null;
  }
  // ãƒ–ãƒ©ã‚¦ã‚¶ã¯é–‰ã˜ãªã„ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒç®¡ç†ï¼‰
}
```

**åŠ¹æœ**:
- åˆå›: ç´„24ç§’ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•ï¼‰
- 2å›ç›®ä»¥é™: ç´„0.5ç§’ï¼ˆãƒšãƒ¼ã‚¸ä½œæˆã®ã¿ï¼‰
- **ç´„23.5ç§’ã®é«˜é€ŸåŒ–**ï¼ˆç´„96%å‰Šæ¸›ï¼‰

### 2. ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ï¼ˆv2.6ã§è¿½åŠ ï¼‰

**ç›®çš„**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¤œç´¢ã™ã‚‹å‰ã«ãƒ–ãƒ©ã‚¦ã‚¶ã‚’äº‹å‰èµ·å‹•

**å®Ÿè£…**:
- API: `src/app/api/warmup/route.ts`
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçµ±åˆ: `src/app/page.tsx`

**ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
```typescript
// /api/warmup
export async function POST() {
  try {
    console.log('ğŸ”¥ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡');

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚’èµ·å‹•ï¼ˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
    browserManager.warmup();

    // ã™ãã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•å®Œäº†ã‚’å¾…ãŸãªã„ï¼‰
    return NextResponse.json({
      status: 'warmup_started',
      message: 'ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã—ãŸ',
    });
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯å½±éŸ¿ã—ãªã„ã‚ˆã†ã«200ã‚’è¿”ã™
    return NextResponse.json({
      status: 'error',
      message: 'ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¤œç´¢æ™‚ã«å†è©¦è¡Œã•ã‚Œã¾ã™ï¼‰',
    });
  }
}
```

**ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®å‘¼ã³å‡ºã—**:
```typescript
// src/app/page.tsx
useEffect(() => {
  // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚’èµ·å‹•ï¼ˆã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
  fetch('/api/warmup', { method: 'POST' }).catch((error) => {
    console.log('ãƒ–ãƒ©ã‚¦ã‚¶ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã—ãŸï¼ˆå®Œäº†ã‚’å¾…ãŸãšã«å‡¦ç†ã‚’ç¶šè¡Œï¼‰');
  });
}, []);
```

**BrowserManager.warmup()ã®å®Ÿè£…**:
```typescript
async warmup(): Promise<void> {
  if (this.browserInstance.state !== 'uninitialized') {
    console.log('â„¹ï¸  ãƒ–ãƒ©ã‚¦ã‚¶ã¯æ—¢ã«èµ·å‹•æ¸ˆã¿ã¾ãŸã¯èµ·å‹•ä¸­ã§ã™');
    return;
  }

  console.log('ğŸ”¥ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ä¸­...');

  // ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã—ã¦ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
  this.initializeBrowser().catch((error) => {
    console.error('âš ï¸  ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•ã«å¤±æ•—ï¼ˆæ¬¡å›ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«å†è©¦è¡Œï¼‰:', error.message);
  });
}
```

**åŠ¹æœ**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ â†’ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•é–‹å§‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¤œç´¢å®Ÿè¡Œ â†’ ãƒ–ãƒ©ã‚¦ã‚¶ãŒæ—¢ã«èµ·å‹•æ¸ˆã¿ â†’ åˆæœŸåŒ–æ™‚é–“ï¼ˆç´„24ç§’ï¼‰ãŒã‚¹ã‚­ãƒƒãƒ—
- **ä½“æ„Ÿå¾…æ©Ÿæ™‚é–“ãŒã»ã¼ã‚¼ãƒ­**

### 3. å¾…æ©Ÿæ™‚é–“ã®æœ€å°åŒ–ï¼ˆv2.5ã§æœ€é©åŒ–ï¼‰

**AJAXå¾…æ©Ÿæ™‚é–“ã®çŸ­ç¸®**:
```typescript
// å¤‰æ›´å‰: 2000ms
await new Promise(resolve => setTimeout(resolve, 2000));

// å¤‰æ›´å¾Œ: 500msï¼ˆ-1.5ç§’ã®é«˜é€ŸåŒ–ï¼‰
await new Promise(resolve => setTimeout(resolve, 500));
```

**ç†ç”±**: `waitForFunction`ã§è¦ç´ ã®è¡¨ç¤ºã‚’ç¢ºèªæ¸ˆã¿ã®ãŸã‚ã€è¿½åŠ ã®å¾…æ©Ÿã¯æœ€å°é™ã§ååˆ†

**waitUntilè¨­å®šã®æœ€é©åŒ–**:
```typescript
// å¤‰æ›´å‰: ã™ã¹ã¦ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¦æ±‚å®Œäº†ã‚’å¾…ã¤
await page.waitForNavigation({ waitUntil: 'networkidle0', timeout: 30000 });

// å¤‰æ›´å¾Œ: DOMæ§‹ç¯‰å®Œäº†ã®ã¿å¾…ã¤ï¼ˆ-0.5~1ç§’ã®é«˜é€ŸåŒ–ï¼‰
await page.waitForNavigation({ waitUntil: 'domcontentloaded', timeout: 30000 });
```

**ç†ç”±**: æ–½è¨­æ¤œç´¢å¾Œã®ãƒšãƒ¼ã‚¸ã§ã¯ã€DOMãŒæ§‹ç¯‰ã•ã‚Œã‚Œã°å¾Œç¶šå‡¦ç†ãŒå¯èƒ½ã€‚ç”»åƒã‚„CSSã®å®Œå…¨èª­ã¿è¾¼ã¿ã‚’å¾…ã¤å¿…è¦ã¯ãªã„

**åŠ¹æœ**: Step 1-2ã§ç´„2ç§’ã®é«˜é€ŸåŒ–ï¼ˆåˆè¨ˆã§14.6ç§’â†’ç´„12ç§’ã€15%æ”¹å–„ï¼‰

### 2. æ—¥ä»˜ã”ã¨ã®ãƒ«ãƒ¼ãƒ—å‡¦ç†

**é‡è¦**: æ–½è¨­ Ã— æ—¥ä»˜ã®çµ„ã¿åˆã‚ã›ãŒ10å€‹ã¾ã§ã®åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€æ—¥ä»˜ã”ã¨ã«ãƒ«ãƒ¼ãƒ—ã—ã¦å‡¦ç†ã—ã¾ã™ã€‚

```typescript
// ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã®åˆ¶é™: æ–½è¨­ Ã— æ—¥ä»˜ â‰¤ 10
// æ–½è¨­ãŒ10å€‹ã‚ã‚‹å ´åˆã€1å›ã«ã¤ã1æ—¥åˆ†ã—ã‹é¸æŠã§ããªã„

const allResults: FacilityAvailability[] = [];

for (let i = 0; i < dates.length; i++) {
  const currentDate = dates[i];

  // 1. æ—¢å­˜ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
  await clearExistingSelections(page);

  // 2. 1æ—¥åˆ†ã‚’é¸æŠ
  await selectDatesOnFacilityCalendar(page, [currentDate]);

  // 3. ãƒ‡ãƒ¼ã‚¿å–å¾—
  const results = await scrapeTimeSlots(page, [currentDate]);
  allResults.push(...results);

  // 4. æœ€å¾Œä»¥å¤–ã¯æˆ»ã‚‹ãƒœã‚¿ãƒ³ã§æ–½è¨­åˆ¥ç©ºãçŠ¶æ³ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹
  if (i < dates.length - 1) {
    await goBackToFacilityCalendar(page);
  }
}

// 5. æ–½è¨­åã§ãƒãƒ¼ã‚¸
const mergedResults = mergeFacilityData(allResults);
```

**æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†**:
```typescript
async goBackToFacilityCalendar(page: Page): Promise<void> {
  // ãƒšãƒ¼ã‚¸å†…ã®ã€Œå‰ã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ã§ã¯ãªã„ï¼‰
  await Promise.all([
    page.waitForNavigation({ waitUntil: 'networkidle0', timeout: 10000 }),
    page.click('.navbar .prev > a'),
  ]);

  // æ–½è¨­åˆ¥ç©ºãçŠ¶æ³ãƒšãƒ¼ã‚¸ (WgR_ShisetsubetsuAkiJoukyou) ã«æˆ»ã£ãŸã“ã¨ã‚’ç¢ºèª
  const currentUrl = page.url();
  if (!currentUrl.includes('WgR_ShisetsubetsuAkiJoukyou')) {
    throw new Error(`äºˆæœŸã—ãªã„ãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã¾ã—ãŸ: ${currentUrl}`);
  }
}
```

**ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸å‡¦ç†**:
```typescript
function mergeFacilityData(results: FacilityAvailability[]): FacilityAvailability[] {
  const facilityMap = new Map<string, FacilityAvailability>();

  results.forEach((result) => {
    const facilityName = result.facility.name;

    if (!facilityMap.has(facilityName)) {
      facilityMap.set(facilityName, result);
    } else {
      // åŒã˜æ–½è¨­ã®ç•°ãªã‚‹æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆ
      const existing = facilityMap.get(facilityName)!;
      existing.availability.push(...result.availability);
    }
  });

  const mergedResults = Array.from(facilityMap.values());

  // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
  mergedResults.forEach((result) => {
    result.availability.sort((a, b) => a.date.getTime() - b.date.getTime());
  });

  return mergedResults;
}
```

---

## åˆ¶ç´„äº‹é …

1. **æ–½è¨­ Ã— æ—¥ä»˜ã®çµ„ã¿åˆã‚ã›åˆ¶é™**
   - ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã®åˆ¶é™: æ–½è¨­ Ã— æ—¥ä»˜ â‰¤ 10
   - æ–½è¨­ãŒ10å€‹ã‚ã‚‹å ´åˆã€1å›ã«ã¤ã1æ—¥åˆ†ã—ã‹é¸æŠã§ããªã„
   - è¤‡æ•°æ—¥ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ã€æ—¥ä»˜ã”ã¨ã«ãƒ«ãƒ¼ãƒ—ã—ã¦å‡¦ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

2. **æœ€å¤§7æ—¥ã¾ã§é¸æŠå¯èƒ½**ï¼ˆæœ¬ã‚·ã‚¹ãƒ†ãƒ ã®åˆ¶é™ï¼‰
   - ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¯¾è±¡ã‚·ã‚¹ãƒ†ãƒ ã¯æœ€å¤§10æ—¥ã¾ã§é¸æŠå¯èƒ½
   - æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã¯7æ—¥é–“ã«åˆ¶é™ã—ã€ã‚·ã‚¹ãƒ†ãƒ ã¸ã®è² è·ã‚’è»½æ¸›

3. **ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é¸æŠã¯å¿…ãšlabelã‚’ã‚¯ãƒªãƒƒã‚¯**
   - `checkbox.checked = true` ã§ã¯å‹•ä½œã—ãªã„

4. **ãƒšãƒ¼ã‚¸é·ç§»ã®é †åºã¯å›ºå®š**
   - Step 1 â†’ Step 2 â†’ Step 3 â†’ Step 4 ã®é †åºã‚’å¤‰æ›´ã§ããªã„

5. **æ–½è¨­ã¯å…¨é¸æŠãŒå‰æ**
   - ç¾åœ¨ã®è¨­è¨ˆã§ã¯å…¨æ–½è¨­ã‚’é¸æŠã™ã‚‹

6. **æ–½è¨­åˆ¥ç©ºãçŠ¶æ³ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºæœŸé–“åˆ¶é™**
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å½“æ—¥ã‹ã‚‰2é€±é–“ã—ã‹è¡¨ç¤ºã•ã‚Œãªã„
   - 2é€±é–“ä»¥ä¸Šå…ˆã®æ—¥ä»˜ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ã€è¡¨ç¤ºæœŸé–“ã‚’1ãƒ¶æœˆã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹

7. **æ—¥ä»˜ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã«æ³¨æ„**
   - `Date.toISOString()`ã¯UTCæ™‚åˆ»ã‚’è¿”ã™ãŸã‚ã€æ—¥æœ¬æ™‚é–“ï¼ˆUTC+9ï¼‰ã§æ—¥ä»˜ãŒ1æ—¥ãšã‚Œã‚‹
   - **å¿…ãš`date-fns`ã®`format(date, 'yyyy-MM-dd')`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨**
   - âŒ NG: `date.toISOString().split('T')[0]` â†’ UTCå¤‰æ›ã«ã‚ˆã‚Šæ—¥ä»˜ãŒãšã‚Œã‚‹
   - âœ… OK: `format(date, 'yyyy-MM-dd')` â†’ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã§æ­£ã—ã„æ—¥ä»˜

8. **æˆ»ã‚‹ãƒœã‚¿ãƒ³ã¯ãƒšãƒ¼ã‚¸å†…ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨**
   - ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯ï¼ˆ`page.goBack()`ï¼‰ã§ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
   - å¿…ãšãƒšãƒ¼ã‚¸å†…ã®ã€Œå‰ã«æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ï¼ˆ`.navbar .prev > a`ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨

9. **æ—¢å­˜ã®é¸æŠã‚’ã‚¯ãƒªã‚¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹**
   - æˆ»ã‚‹ãƒœã‚¿ãƒ³ã§æ–½è¨­åˆ¥ç©ºãçŠ¶æ³ãƒšãƒ¼ã‚¸ã«æˆ»ã£ãŸéš›ã€å‰å›ã®æ—¥ä»˜é¸æŠãŒæ®‹ã£ã¦ã„ã‚‹
   - æ–°ã—ã„æ—¥ä»˜ã‚’é¸æŠã™ã‚‹å‰ã«ã€å¿…ãšæ—¢å­˜ã®é¸æŠã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã“ã¨

---

## ä»Šå¾Œã®æ”¹å–„æ¡ˆ

1. **æ–½è¨­ã®çµã‚Šè¾¼ã¿**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç‰¹å®šã®æ–½è¨­ã®ã¿ã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

2. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿæ§‹**
   - å–å¾—ã—ãŸç©ºãçŠ¶æ³ã‚’ä¸€å®šæ™‚é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹
   - ã‚·ã‚¹ãƒ†ãƒ ã¸ã®è² è·ã‚’è»½æ¸›

3. **ãƒªãƒˆãƒ©ã‚¤å‡¦ç†**
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤

4. **ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€²æ—çŠ¶æ³ã‚’è¡¨ç¤º

---

**ä½œæˆè€…**: Claude (AI Assistant)
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.6
**æœ€çµ‚æ›´æ–°**: 2025-12-08
