# 実装ギャップ分析レポート

## 調査日
2025-12-06

## エグゼクティブサマリー

現在の実装と要件との間に重大なギャップが発見されました。

### 主な発見事項

1. **要件の曖昧さ**: requirements.mdでは「Phase 2で実装予定」としているが、実際には不完全な実装が存在
2. **実装の不整合**: スクレイパーが「本日の予定」を取得しようとしているが、実際のHTMLには該当データが存在しない
3. **ユーザー体験の欠落**: 検索結果に常に「空き状況データがありません」が表示され、実質的に機能していない

## 現状の問題点

### 問題1: 空き状況データが取得できない

**症状**:
- ユーザーが12/11を検索しても、12/10の結果が表示される
- 全ての施設で「0/5」「0/8」などの空き表示になる
- アコーディオンを開いても「空いていない」のみが表示される

**根本原因**:
```typescript
// src/lib/scraper/index.ts:scrapeAvailability メソッド
// Line 353-358: 「本日の予定」セクションを探そうとしている
const facilityHeading = headings.find(h =>
  h.textContent?.includes(facilityName) &&
  h.textContent?.includes('の本日の予定')  // ← このセクションは空
);
```

**実際のHTML**: (docs/investigation/availability-page-auto.html)
```html
<!-- 本日の予定start -->
            <!-- 空のコメントのみ -->
<!-- 本日の予定end -->
```

### 問題2: 要件と実装の不一致

**requirements.md の記述** (Line 108-119):
```markdown
2. **ナビゲーション手順（Phase 1実装完了）**
   1. 使用目的の選択 ✅
   2. スポーツ種目の選択 ✅
   3. 施設一覧の取得 ✅
   4. 日付の選択 ⏸️（Phase 2で実装予定）
   5. 空き状況の取得 ⏸️（Phase 2で実装予定）

2-2. **現在の実装状況**
   - ⏸️ Phase 2延期: 日付選択と空き状況の詳細取得は将来の拡張として延期
   - 空き状況データがない施設には、宇美町の公式サイトへのリンクを表示する SHALL
```

**実際の実装**:
- ステップ4-5が「延期」と記載されているにも関わらず、不完全な実装が存在
- 「本日の予定」からデータを取得しようとしているが、このアプローチは機能しない
- 結果として、全ての施設で「空き状況データがありません」が表示される

### 問題3: 日付のズレ

**症状**: 12/11を検索すると12/10が表示される

**原因**: `scrapeAvailability`メソッドで以下の処理が行われている
```typescript
// Line 403-404
const today = new Date();  // ← ユーザーが選択した日付を無視
today.setHours(0, 0, 0, 0);
```

しかし、これ以前の修正で`dates`パラメータを使用するように変更したため、この問題は**部分的に解決済み**。ただし、データ取得自体が機能していないため、意味がない。

## 正しいフロー（実際の宇美町システム）

宇美町の施設予約システムで空き状況を確認する正しいフローは以下の通り:

### 1. 初期ページ → 施設一覧ページ (実装済み ✅)
```
1. 使用目的の選択（屋内スポーツ）
2. スポーツ種目の選択（バスケットボール/ミニバスケットボール）
3. 検索ボタンクリック
→ 施設一覧ページに遷移
```

### 2. 施設一覧ページ → 日付選択ページ (未実装 ❌)
```
1. 施設のチェックボックスを選択
2. 「次へ進む」ボタンをクリック
→ 日付選択ページに遷移
```

### 3. 日付選択ページ → 空き状況ページ (未実装 ❌)
```
1. カレンダーから日付を選択
2. 検索/次へボタンをクリック
→ 時間帯別空き状況ページに遷移
```

### 4. 空き状況ページでのデータ取得 (未実装 ❌)
```
1. 時間帯テーブルから空き情報をパース
2. ○(空き)、△(一部空き)、×(空いていない) の判定
3. データを構造化して返す
```

## 必要な対応

### オプション1: Phase 2の完全実装（推奨）

**作業内容**:
1. 日付選択ページへの遷移処理を実装
2. カレンダーUIの操作（日付クリック）を実装
3. 空き状況ページでのデータパース実装
4. 複数日対応の実装

**メリット**:
- 完全に機能するアプリケーションになる
- ユーザーの期待に応える

**デメリット**:
- 実装工数が大きい（2-3日程度）
- スクレイピングの複雑度が増す

### オプション2: 最小限の実装（暫定対応）

**作業内容**:
1. 現在のスクレイパーを削除
2. 施設一覧のみを返す
3. 全ての施設に「詳細は公式サイトで確認」のリンクを表示

**メリット**:
- 実装が簡単（1-2時間）
- 嘘の情報を表示しない

**デメリット**:
- 実質的に施設一覧アプリになる
- プロダクトの価値が低下

### オプション3: 本日の予定のみ対応（技術的に不可能）

**判定**: ❌ 実装不可

**理由**:
- HTMLに「本日の予定」セクションが存在するが、**常に空**
- 宇美町のシステムが動的に生成していない可能性が高い
- このアプローチでは機能しない

## 推奨アクション

### 短期（即座に対応）
1. requirements.mdを更新し、Phase 2が「必須」であることを明記
2. 現在の不完全な実装を削除または修正
3. ユーザーに正直な情報を表示（「現在、空き状況の取得機能は開発中です」）

### 中期（次のイテレーション）
1. design.mdを更新し、完全なスクレイピングフローを設計
2. tasks.mdに具体的なタスクを追加
3. Phase 2の完全実装を実施

### 長期（将来の拡張）
1. キャッシュ機能の追加（同じ日付の検索を高速化）
2. 複数施設の並列スクレイピング
3. エラー時のフォールバック改善

## 影響範囲

### 修正が必要なファイル

1. **requirements.md**
   - Phase 2の位置づけを「延期」から「必須」に変更
   - 空き状況取得の要件を明確化

2. **design.md**
   - 完全なスクレイピングフローの設計を追加
   - 日付選択ページ、空き状況ページの構造を定義

3. **tasks.md**
   - Phase 2の実装タスクを追加
   - 優先度を高に設定

4. **src/lib/scraper/index.ts**
   - `scrapeAvailability` メソッドを完全に書き換え
   - 日付選択、ページ遷移の処理を追加

5. **src/components/FacilityCard.tsx**
   - 空き状況がない場合の表示を改善
   - 暫定的に正直なメッセージを表示

## 次のステップ

1. ✅ このレポートをレビュー
2. ⏳ 要件・設計の修正方針を決定
3. ⏳ requirements.md、design.md、tasks.md を更新
4. ⏳ 実装開始

---

**作成者**: Claude (AI Assistant)
**レビュー待ち**: プロジェクトオーナー
