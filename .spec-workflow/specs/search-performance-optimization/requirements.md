# Requirements Document

## Introduction

宇美町施設予約検索システムにおいて、現在の検索速度が遅い問題を解決します。特に複数日を検索する場合、2〜3分程度かかっており、ユーザー体験を損なっています。

**🔍 API構造調査により、根本的な高速化が可能であることが判明しました。**

現在の実装は、ブラウザでユーザーが手動操作するフローを忠実にトレース（7ステップ）していますが、宇美町システムは `__VIEWSTATE` や `__EVENTVALIDATION` を使用していないため、**直接APIエンドポイントに必要なパラメータをPOSTすることで、中間の5ステップをスキップできます**。

インフラコストをかけずに、以下の最適化を実施することで検索速度を大幅に改善します：

### 最優先アプローチ: 直接API呼び出し（★新規追加★）
1. **直接API呼び出し**: 中間ページをスキップして、最終データ取得APIに直接アクセス
   - 期待効果: **7日検索が 120〜180秒 → 20〜40秒（75%削減）**

### 補助的な最適化（直接API呼び出しと併用）
2. **リソース読み込みの最適化**: 不要なリソース（画像・CSS・フォント）の読み込みをブロック
3. **プログレス表示の追加**: リアルタイムで処理状況を表示し、体感速度を改善
4. **処理ログの詳細化**: パフォーマンス計測とボトルネック特定

これにより、実際の処理時間を劇的に短縮すると同時に、ユーザーが待ち時間を感じにくくする仕組みを提供します。

## Alignment with Product Vision

本プロジェクトは宇美町の施設予約情報を簡単に検索できるようにすることを目的としています。検索速度の改善は以下の点でプロダクトビジョンに貢献します：

- **ユーザー体験の向上**: 待ち時間の短縮により、ユーザーがストレスなく施設を検索できる
- **利用率の向上**: 快適な検索体験により、リピート利用が増加する
- **コスト効率**: インフラを増強せずにパフォーマンスを改善し、持続可能な運用を実現

## Requirements

### Requirement 1: 直接API呼び出しによる根本的高速化（★最優先★）

**User Story:** 開発者として、宇美町システムのAPIに直接パラメータをPOSTして、中間ページ遷移をスキップしたい。そうすることで、検索時間を75%削減できる。

#### Acceptance Criteria

1. WHEN システムが検索を開始する THEN 検索ページ・スポーツ選択・施設選択の3ステップをスキップして、直接施設別空き状況ページにアクセスする SHALL
2. WHEN 施設別空き状況ページにアクセスする THEN システムは固定の施設ID（341007, 341009など）と日付パラメータを使用してPOSTリクエストを送信する SHALL
3. WHEN POSTリクエストを送信する THEN システムは `__RequestVerificationToken` を初回アクセス時に取得して使用する SHALL
4. WHEN 複数日を検索する THEN システムは各日付に対して施設別空き状況ページから時間帯別空き状況ページへの遷移のみを行う SHALL
5. WHEN 直接API呼び出しを実装した THEN システムは7日検索において100〜140秒の速度改善を実現する SHALL
6. IF 直接API呼び出しが失敗した場合 THEN システムは従来の7ステップフローにフォールバックする SHALL

#### 調査結果の詳細

API構造調査により、以下が判明:
- `__VIEWSTATE` / `__EVENTVALIDATION` が存在しない（ASP.NET WebFormsの複雑な状態管理なし）
- 各リクエストは独立しており、セッションCookieと `__RequestVerificationToken` のみで認証される
- 施設IDは固定値（341007=宇美勤労者体育センター、など）
- 日付パラメータは `checkdate=YYYYMMDD{施設ID}+++0` の形式

**必要なリクエストパラメータ例**:
```
POST /Umi/web/Yoyaku/WgR_ShisetsubetsuAkiJoukyou
__RequestVerificationToken: {トークン}
__EVENTTARGET: next
checkdate: 2025120900701+++0
checkdate: 2025120900907+++0
(施設×日付の組み合わせ)
```

### Requirement 2: 待機時間の動的最適化（補助的）

**User Story:** 開発者として、固定の待機時間を動的な条件チェックに置き換えたい。そうすることで、必要最小限の待機時間で次の処理に進むことができる。

#### Acceptance Criteria

1. WHEN ページ遷移後にDOMの読み込みを待機する THEN システムは `setTimeout(固定時間)` の代わりに `waitForFunction()` を使用して条件が満たされるまで動的に待機する SHALL
2. WHEN AJAX更新後の待機が必要な場合 THEN システムは実際のDOM更新完了を検知してから次の処理に進む SHALL
3. WHEN スポーツ種目選択後の待機が必要な場合 THEN システムはチェックボックス要素が表示状態になったことを確認してから次の処理に進む SHALL
4. IF 動的待機がタイムアウトした場合 THEN システムは適切なエラーメッセージを表示する SHALL
5. WHEN すべての固定待機時間を動的待機に置き換えた THEN システムは1日あたり2〜4秒、7日検索で14〜28秒の速度改善を実現する SHALL

### Requirement 3: 不要リソースの読み込みブロック（補助的）

**User Story:** 開発者として、スクレイピング時に不要なリソース（画像・CSS・フォント）の読み込みをブロックしたい。そうすることで、ページ読み込み時間を短縮できる。

#### Acceptance Criteria

1. WHEN Puppeteerでページにアクセスする THEN システムはリクエストインターセプションを有効化する SHALL
2. WHEN 画像・CSS・フォントのリクエストが発生する THEN システムはそれらのリクエストを中止(abort)する SHALL
3. WHEN HTML・JavaScript・XHRのリクエストが発生する THEN システムはそれらのリクエストを許可(continue)する SHALL
4. WHEN リソースブロックを適用した THEN システムはページ遷移ごとに0.5〜1秒の速度改善を実現する SHALL
5. IF リソースブロックによりページの機能が損なわれた場合 THEN システムは該当リソースタイプをブロック対象から除外する SHALL

### Requirement 4: リアルタイムプログレス表示

**User Story:** ユーザーとして、検索処理中にリアルタイムで進捗状況を確認したい。そうすることで、どの段階の処理が行われているか把握でき、待ち時間を感じにくくなる。

#### Acceptance Criteria

1. WHEN 検索を開始する THEN システムはプログレス表示UIを表示する SHALL
2. WHEN 各ステップ（施設選択、日付選択、データ取得など）を処理する THEN システムは現在の処理内容をリアルタイムで表示する SHALL
3. WHEN 複数日を検索する THEN システムは「X/Y日目を処理中...」という形式で進捗を表示する SHALL
4. WHEN 各日付の処理が完了する THEN システムは進捗バーまたはパーセンテージを更新する SHALL
5. WHEN すべての処理が完了する THEN システムはプログレス表示を非表示にして結果画面に遷移する SHALL
6. IF 処理中にエラーが発生した場合 THEN システムはプログレス表示にエラー情報を表示して処理を中断する SHALL

### Requirement 5: 処理ログの詳細化

**User Story:** 開発者として、各処理ステップの所要時間を計測したい。そうすることで、ボトルネックを特定し、さらなる最適化の判断材料にできる。

#### Acceptance Criteria

1. WHEN 各処理ステップを開始する THEN システムは開始時刻を記録する SHALL
2. WHEN 各処理ステップを完了する THEN システムは所要時間をログに出力する SHALL
3. WHEN スクレイピング全体が完了する THEN システムは合計所要時間と各ステップの内訳をログに出力する SHALL
4. WHEN ログを出力する THEN システムは日本語で分かりやすい形式で出力する SHALL

### Requirement 6: 段階的レンダリング（Progressive Rendering）

**User Story:** ユーザーとして、検索処理中に取得済みのデータをリアルタイムで閲覧したい。そうすることで、全検索完了を待たずにデータを確認でき、体感速度が大幅に改善される。

**実装完了日**: 2025-12-09

#### Acceptance Criteria

1. WHEN 検索を開始する THEN システムは即座に結果ページ（/results）に遷移する SHALL
2. WHEN 検索を開始する THEN システムはServer-Sent Events（SSE）接続を確立する SHALL
3. WHEN 各日付の処理が完了する THEN システムは部分結果をSSE経由でリアルタイム送信する SHALL
4. WHEN 部分結果を受信する THEN フロントエンドは段階的にカードを追加表示する SHALL
5. WHEN 新しいカードを追加する THEN システムはフェードインアニメーション（animate-fade-in-up）を適用する SHALL
6. WHEN データ取得中 THEN システムは「取得済み: X/Y日」のプログレス表示を更新する SHALL
7. WHEN 初回ローディング時 THEN システムはスケルトンスクリーン（Skeleton Screens）を表示する SHALL
8. WHEN スクロール中 THEN 検索条件ヘッダーとフッターボタンはスティッキー表示される SHALL
9. WHEN 全検索が完了する THEN システムは完了通知を表示し、SSE接続を切断する SHALL
10. IF SSE接続エラーが発生した場合 THEN システムは取得済みデータを保持し、エラーメッセージを表示する SHALL
11. IF タブクローズやブラウザバック THEN システムはSSE接続を適切にクリーンアップする SHALL

#### パフォーマンス指標

- **初回データ表示**: 30秒以降 → 4.6秒（**85%短縮**）を達成する SHALL
- **体感速度**: ユーザーが「非常に遅い」から「快適」と感じる改善を実現する SHALL
- **データ可用性**: 全検索完了前に取得済みデータを閲覧可能にする SHALL

#### 実装された主要コンポーネント

1. **SSEストリーミング（API側）**
   - イベントタイプ: `progress`, `partial-result`, `complete`, `error`
   - 部分結果コールバック: `partialResultCallback(date, facilities)`
   - タイムアウト: 180秒（3分）

2. **段階的レンダリング（フロントエンド）**
   - EventSource APIを使用したSSE接続
   - 受信データのマージとステート更新
   - リアルタイムプログレス表示

3. **UX改善要素**
   - スケルトンスクリーン: 初回ローディング時の期待感演出
   - フェードインアニメーション: 新カード追加時の視覚効果
   - スティッキーヘッダー/フッター: 常時操作可能
   - 完了通知: 検索完了時の明確なフィードバック

## Non-Functional Requirements

### Code Architecture and Modularity
- **Single Responsibility Principle**: 各最適化機能は独立したメソッドまたはユーティリティとして実装する
- **Modular Design**: 待機時間最適化、リソースブロック、プログレス表示は独立して有効化/無効化できる設計とする
- **Dependency Management**: 既存のスクレイピングロジックへの影響を最小限に抑える
- **Clear Interfaces**: プログレス更新のためのイベント駆動アーキテクチャを採用する

### Performance
- **直接API呼び出し**: 7日検索において100〜140秒の速度改善を達成する（最優先）
- **リソース読み込みの削減**: ページ遷移ごとに0.5〜1秒の速度改善を達成する（補助的）
- **体感速度の改善**: プログレス表示により、ユーザーが待ち時間を感じにくくする
- **総合目標**: 7日検索を 120〜180秒 から 20〜40秒 に短縮（75%削減）

### Security
- **スクレイピング制限の遵守**: 既存のレート制限（5秒間隔）を維持する
- **エラーハンドリング**: 最適化によりエラーが増加しないよう、適切なエラーハンドリングを実装する

### Reliability
- **後方互換性**: 最適化により既存の機能が損なわれないことを保証する
- **フォールバック機能**: 動的待機がタイムアウトした場合、適切にエラーを報告する
- **テスト**: 最適化後も既存のテストが合格することを確認する

### Usability
- **プログレス表示の明確性**: ユーザーが現在の処理状況を直感的に理解できる
- **エラーメッセージの改善**: エラーが発生した場合、ユーザーに分かりやすいメッセージを表示する
- **レスポンシブデザイン**: プログレス表示はモバイルデバイスでも適切に表示される
