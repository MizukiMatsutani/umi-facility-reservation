# Requirements Document

## イントロダクション

宇美町施設予約検索システム（umi-facility-search）は、バスケットボールチームメンバーが宇美町の体育館施設の空き状況を迅速かつ簡単に確認できるモバイルファーストのWebアプリケーションです。

### 背景
現在の宇美町施設予約確認システム（https://www.11489.jp/Umi/web/Home/WgR_ModeSelect）は以下の課題を抱えています：

- **操作導線が複雑**: 7ステップ以上のクリック操作が必要（使用目的選択 → スポーツ選択 → 施設選択 → 日付選択 → 検索結果表示）
- **モバイルUI不十分**: 横スクロールと縦スクロールが混在し、スマートフォンでの操作が困難
- **不要な情報入力**: バスケットボール利用者にとって関係のない選択肢が多数存在

### 目的
本システムは、既存システムの代替インターフェースとして、最小限の入力で施設の空き状況を確認できる体験を提供します。

### 価値提案
- **時間短縮**: 検索完了時間を2分以上から30秒以内に短縮
- **操作簡素化**: 操作ステップを7ステップから2ステップに削減
- **モバイル最適化**: スマートフォンでストレスなく利用できるUI

## プロダクトビジョンとの整合性

本システムは、product.md で定義されたプロダクト原則に完全に準拠します：

1. **モバイルファースト**: すべてのUI設計はスマートフォン利用を最優先
2. **シンプルさの徹底**: 必要最小限の入力と情報表示
3. **信頼性と配慮**: スクレイピング先への負荷を最小化し、適切なローディング表示でUX向上

また、tech.md で定義された技術スタックを活用：
- Next.js 15.x (App Router) によるモバイル最適化
- TailwindCSSによるレスポンシブデザイン
- Puppeteer/Playwrightによる信頼性の高いスクレイピング

## 要件

### 要件1: 日付と時間帯による検索

**ユーザーストーリー**: バスケットボールチームメンバーとして、練習可能な日時の施設を探すために、複数日と時間帯を指定して検索したい

#### 受入基準

1. **複数日選択**
   - WHEN ユーザーが検索フォームにアクセスした THEN システムは日付選択UIを表示する SHALL
   - WHEN ユーザーが日付を選択する THEN システムは複数日の選択を許可する SHALL
   - WHEN ユーザーが日付を選択する THEN システムは選択された日付を視覚的に区別して表示する SHALL

2. **クイック日付選択**
   - WHEN ユーザーが「本日から1週間」ボタンをクリックした THEN システムは本日を含む7日間を自動選択する SHALL
   - クイック選択により、ユーザーは手動で複数日を選択する手間を省ける SHALL

3. **バリデーション**
   - IF ユーザーが日付を選択していない THEN システムは検索実行を防止し、エラーメッセージを表示する SHALL
   - IF ユーザーが過去の日付を選択した THEN システムは警告メッセージを表示する SHALL（検索は実行可能）

### 要件2: モバイル最適化された検索結果表示

**ユーザーストーリー**: モバイルユーザーとして、スマートフォンで快適に検索結果を閲覧したい

#### 受入基準

1. **空き施設のみ表示**
   - WHEN 検索が完了した THEN システムは空き時間がある施設のみを表示する SHALL
   - IF 全ての施設が予約済みの場合 THEN システムは「空きがありません」メッセージを表示する SHALL

2. **縦スクロールのみのレイアウト**
   - システムは検索結果を縦スクロールのみで閲覧可能なレイアウトで表示する SHALL
   - システムは横スクロールを必要としない SHALL

3. **施設情報の表示**
   - WHEN 検索結果を表示する THEN システムは各施設について以下を表示する SHALL:
     - 施設名
     - 選択された日付ごとの空き状況
     - 各時間帯の状態（空き/空いていない）

4. **時間帯の展開/折りたたみ**
   - システムはデフォルトで空き時間帯のみを表示する SHALL
   - WHEN ユーザーが展開操作を行う THEN システムは全時間帯（空き/空いていない）を表示する SHALL
   - 展開操作により、ユーザーは前後の予約状況を把握できる SHALL

5. **タッチ操作の最適化**
   - システムはタップ可能な要素を44px × 44px以上のサイズで提供する SHALL
   - システムはスワイプやピンチ操作を妨げない SHALL

### 要件3: スクレイピングによるデータ取得

**ユーザーストーリー**: システム管理者として、宇美町の既存システムからデータを取得し、ユーザーに最新情報を提供したい

#### 受入基準

1. **スクレイピング実行**
   - WHEN ユーザーが検索を実行する THEN システムは宇美町システム（https://www.11489.jp/Umi/web/Home/WgR_ModeSelect）にアクセスする SHALL
   - システムはバスケットボールおよびミニバスケットボールの施設情報のみを取得する SHALL

2. **ナビゲーション手順（完全実装が必須）**
   - システムは以下の手順でスクレイピングを実行する SHALL:
     1. 使用目的の選択（屋内スポーツ） ✅
     2. スポーツ種目の選択（バスケットボール/ミニバスケットボール） ✅
     3. 施設一覧の取得 ✅
     4. 施設の選択（チェックボックス選択） ⏳（Phase 2で実装中）
     5. 日付選択ページへの遷移 ⏳（Phase 2で実装中）
     6. カレンダーから日付を選択 ⏳（Phase 2で実装中）
     7. 時間帯別空き状況ページへの遷移 ⏳（Phase 2で実装中）
     8. 空き状況データの取得とパース ⏳（Phase 2で実装中）

2-2. **日付選択の詳細要件**
   - WHEN ユーザーが複数日を指定した THEN システムは各日付に対して個別にスクレイピングを実行する SHALL
   - WHEN 施設一覧ページで施設を選択した THEN システムは「次へ進む」ボタンをクリックして日付選択ページに遷移する SHALL
   - WHEN 日付選択ページに到達した THEN システムはカレンダーUIから指定日付をクリックする SHALL
   - システムは日付選択後、時間帯別空き状況ページに遷移する SHALL

2-3. **空き状況データの取得要件**
   - WHEN 時間帯別空き状況ページに到達した THEN システムは時間帯テーブルから以下のデータを取得する SHALL:
     - 時間帯（例: "9:00", "9:30"）
     - 空き状況（○=空き、△=一部空き、×=空いていない、-=対象外）
   - システムは取得したデータをTimeSlot型（`{time: string, available: boolean}`）に変換する SHALL

3. **レート制限**
   - システムはリクエスト間隔を最低5秒空ける SHALL
   - システムは同時に1つのスクレイピングリクエストのみを実行する SHALL

4. **タイムアウト処理**
   - IF スクレイピング処理が30秒を超える THEN システムはタイムアウトエラーを返す SHALL
   - WHEN タイムアウトが発生した THEN システムはユーザーにエラーメッセージを表示する SHALL
   - 各ページ遷移の個別タイムアウトは10秒とする SHALL（合計で複数ページ遷移するため全体で30秒）

5. **エラーハンドリング**
   - IF スクレイピング先のHTML構造が変更されている THEN システムはエラーを検知し、ユーザーに通知する SHALL
   - IF ネットワークエラーが発生した THEN システムは再試行を1回実行する SHALL
   - IF 2回目も失敗した THEN システムはエラーメッセージを表示する SHALL

### 要件4: ローディング状態の表示

**ユーザーストーリー**: ユーザーとして、処理の進行状況を把握し、待ち時間のストレスを軽減したい

#### 受入基準

1. **ローディングインジケーター**
   - WHEN 検索ボタンがクリックされた THEN システムはローディングインジケーターを表示する SHALL
   - ローディングインジケーターはアニメーション付きで表示される SHALL
   - WHEN データ取得が完了した THEN システムはローディングインジケーターを非表示にする SHALL

2. **進行状況メッセージ**
   - システムはローディング中に進行状況を示すメッセージを表示する SHALL:
     - 「施設情報を取得中...」
     - 「空き状況を確認中...」

3. **操作不可状態の明示**
   - WHEN データ取得中の場合 THEN システムは検索ボタンを無効化する SHALL
   - WHEN データ取得中の場合 THEN システムは検索フォームの入力を無効化する SHALL

4. **キャンセル機能（将来拡張）**
   - 初期バージョンではキャンセル機能は実装しない
   - 将来的にキャンセルボタンの追加を検討する

### 要件5: エラー表示とフォールバック

**ユーザーストーリー**: ユーザーとして、エラーが発生した際に原因を理解し、次のアクションを判断したい

#### 受入基準

1. **エラーメッセージの表示**
   - WHEN エラーが発生した THEN システムはユーザーフレンドリーなエラーメッセージを表示する SHALL
   - エラーメッセージは以下の情報を含む SHALL:
     - エラーの概要
     - 推奨される対処方法

2. **エラー種別ごとのメッセージ**
   - システムは以下のエラータイプごとに適切なメッセージを表示する SHALL:
     - ネットワークエラー: 「インターネット接続を確認してください」
     - タイムアウト: 「処理に時間がかかっています。もう一度お試しください」
     - スクレイピング失敗: 「データの取得に失敗しました。しばらく経ってから再度お試しください」
     - バリデーションエラー: 「日付を選択してください」

3. **再試行機能**
   - WHEN エラーが表示された THEN システムは「再試行」ボタンを表示する SHALL
   - WHEN ユーザーが再試行ボタンをクリックした THEN システムは同じ検索条件で再度検索を実行する SHALL

4. **エラーログ（将来拡張）**
   - 初期バージョンではエラーログ機能は実装しない
   - 将来的にサーバーサイドでのエラーログ記録を検討する

### 要件6: レスポンシブデザイン

**ユーザーストーリー**: ユーザーとして、使用するデバイスに関わらず快適に利用したい

#### 受入基準

1. **モバイルファースト設計**
   - システムはモバイル（375px幅）でのレイアウトを優先的に設計する SHALL
   - システムはiOS Safari 14+およびAndroid Chrome 90+で正常に動作する SHALL

2. **ブレークポイント**
   - システムは以下のブレークポイントでレイアウトを調整する SHALL:
     - モバイル: 〜640px（デフォルト）
     - タブレット: 641px〜1024px（対応は任意）
     - デスクトップ: 1025px〜（対応は任意）

3. **タッチ操作とマウス操作**
   - システムはタッチ操作（タップ、スワイプ）をサポートする SHALL
   - システムはマウス操作（クリック、ホバー）もサポートする SHALL

4. **フォントサイズの最適化**
   - システムは本文テキストを16px以上のサイズで表示する SHALL（モバイルでの可読性確保）
   - システムは見出しを適切なサイズで階層的に表示する SHALL

### 要件7: UX改善機能（Phase 1で実装完了）

**ユーザーストーリー**: ユーザーとして、検索フォームを快適に操作し、エラー時にも入力内容を保持したい

#### 受入基準

1. **リセットボタン** ✅
   - WHEN ユーザーが検索フォームに入力した THEN システムはリセットボタンを表示する SHALL
   - WHEN ユーザーがリセットボタンをクリックした THEN システムはすべての入力内容（日付）をクリアする SHALL
   - リセットボタンは検索ボタンと並んで配置され、モバイルでは縦並び、PCでは横並びで表示される SHALL
   - リセットボタンは44px × 44px以上のタップ可能なサイズである SHALL

2. **エラー時の入力状態保持** ✅
   - WHEN 検索がエラーになった THEN システムは選択した日付を保持する SHALL
   - WHEN エラーメッセージが表示された THEN システムは検索フォームを再表示し、保持した入力内容を初期値として設定する SHALL
   - ユーザーは再入力することなく、条件を修正して再検索できる SHALL

3. **外部リンクの提供** ✅
   - WHEN 施設の空き状況データがない THEN システムは「空き状況データがありません」というメッセージを表示する SHALL
   - システムは宇美町の公式施設予約サイト（https://www.11489.jp/Umi/web/Home/WgR_ModeSelect）へのリンクを表示する SHALL
   - リンクは新しいタブで開く（target="_blank"）SHALL
   - リンクには外部リンクアイコンが表示される SHALL

## 非機能要件

### コードアーキテクチャとモジュール性

- **単一責任の原則**: 各ファイルは単一の明確な目的を持つ
- **モジュラー設計**: コンポーネント、ユーティリティ、サービスは独立して再利用可能
- **依存関係管理**: モジュール間の相互依存を最小化
- **明確なインターフェース**: コンポーネントとレイヤー間に明確な契約を定義
- **レイヤー分離**: structure.md で定義された通り、プレゼンテーション → ビジネスロジック → 外部サービスの依存方向を厳守

### パフォーマンス

1. **初回表示時間**
   - ページの初回表示は2秒以内
   - Lighthouse Performance スコア90以上を目標

2. **検索結果取得時間**
   - 検索結果の取得は10秒以内（スクレイピング処理含む）
   - 30秒以内の完了を目標

3. **モバイル最適化**
   - Lighthouse Mobile Score 90以上
   - First Contentful Paint (FCP): 1.8秒以内
   - Largest Contentful Paint (LCP): 2.5秒以内

4. **バンドルサイズ**
   - JavaScriptバンドルサイズは300KB以下（gzip圧縮後）

### セキュリティ

1. **HTTPS通信**
   - すべての通信はHTTPS経由で実行
   - Render.comのデフォルト証明書を使用

2. **XSS対策**
   - ReactのデフォルトXSS保護を活用
   - dangerouslySetInnerHTML は使用しない

3. **スクレイピング先への配慮**
   - User-Agentヘッダーを適切に設定
   - レート制限を厳守
   - DoS攻撃にならないよう同時リクエスト数を制限

4. **個人情報保護**
   - ユーザーの検索履歴は保存しない
   - Cookie/LocalStorageは使用しない（初期バージョン）

### 信頼性

1. **可用性**
   - Render.com無料枠の範囲内で99%アップタイムを目標
   - ダウンタイムはRender.comのメンテナンス時のみ

2. **エラーハンドリング**
   - すべてのAPIエンドポイントは適切なエラーレスポンスを返す
   - スクレイピング失敗時のフォールバック処理を実装

3. **再試行ロジック**
   - ネットワークエラー時に1回の自動再試行
   - ユーザー操作による手動再試行をサポート

4. **モニタリング（将来拡張）**
   - 初期バージョンではモニタリング機能は実装しない
   - 将来的にエラー率、レスポンスタイムのモニタリングを検討

### ユーザビリティ

1. **モバイルユーザビリティ**
   - タップ可能な要素は44px × 44px以上
   - フォーム入力は適切なキーボードタイプを使用
   - スクロール方向は縦方向のみ

2. **アクセシビリティ基本対応**
   - 適切なHTML要素を使用（セマンティックHTML）
   - 画像には代替テキストを設定
   - フォーム要素には適切なラベルを設定
   - カラーコントラスト比は最低4.5:1を確保

3. **日本語対応**
   - すべてのUI要素は日本語で表示
   - 日付フォーマットは日本のロケールに従う（例: 2025年12月5日）

4. **操作のシンプルさ**
   - 検索実行までの操作は最大2ステップ
   - 不要な入力項目を排除

### 互換性

1. **ブラウザサポート**
   - iOS Safari 14+
   - Android Chrome 90+
   - デスクトップブラウザはベストエフォート対応

2. **画面サイズ**
   - 最小対応幅: 320px（iPhone SE）
   - 最大対応幅: 1920px

3. **ネットワーク環境**
   - 4G LTE環境での快適な動作を保証
   - 3G環境でも基本機能が動作

### メンテナンス性

1. **コード品質**
   - TypeScriptの型チェックを100%通過
   - ESLintエラーゼロ
   - Prettierによるコードフォーマット統一

2. **ドキュメント**
   - 公開APIにはJSDocコメントを記載
   - 複雑なロジックにはインラインコメントを記載
   - README.mdでセットアップ手順を説明

3. **テスト**
   - TDD（テスト駆動開発）アプローチでユニットテストを実装する
   - 重要なビジネスロジック（日付処理、バリデーション、スクレイピングロジック）にはユニットテストを記述する
   - E2Eテストは初期バージョンでは実装しない（将来的な拡張として検討）

4. **運用コスト**
   - Render.com無料枠内での運用（月額0円）
   - 追加のインフラコストは発生させない

## スコープ外事項

以下の機能は初期バージョンのスコープ外とします：

1. **予約機能**
   - 本システムは空き状況の確認のみを提供
   - 実際の予約は宇美町窓口で実施

2. **ユーザー認証**
   - 誰でもアクセス可能
   - ログイン機能は実装しない

3. **検索履歴の保存**
   - 検索条件や結果の保存機能は実装しない

4. **通知機能**
   - プッシュ通知やメール通知は実装しない

5. **お気に入り機能**
   - 施設や検索条件のお気に入り登録は実装しない

6. **キャッシュ機能**
   - データベースやRedisによるキャッシュは実装しない
   - すべての検索でリアルタイムスクレイピングを実行

7. **管理画面**
   - 管理者向けの画面は実装しない

8. **多言語対応**
   - 日本語のみをサポート

9. **他スポーツ種目の対応**
   - バスケットボール/ミニバスケットボールのみをサポート

10. **他自治体施設の対応**
    - 宇美町施設のみをサポート
