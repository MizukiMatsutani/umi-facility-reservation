# Technology Stack

## プロジェクトタイプ
Webアプリケーション - モバイルファーストの施設予約確認システム

## コア技術

### 主要言語
- **言語**: TypeScript
- **ランタイム**: Node.js 20.x
- **言語固有ツール**: pnpm 9.x

### 主要な依存関係・ライブラリ

#### フロントエンド
- **Next.js (App Router)**: Reactベースのフルスタックフレームワーク（v15.x - 最新LTS）
  - サーバーサイドレンダリング（SSR）
  - API Routes機能
  - 静的サイト生成（SSG）の活用
- **React**: UIライブラリ（Next.jsに含まれる）
- **TailwindCSS**: ユーティリティファーストのCSSフレームワーク
  - モバイルファーストなレスポンシブデザイン
  - カスタマイズ可能なデザインシステム

#### バックエンド（Next.js API Routes内）
- **Puppeteer** または **Playwright**: ヘッドレスブラウザによるスクレイピング
  - 動的コンテンツの取得
  - セッション管理
- **Cheerio**: HTMLパース（必要に応じて）
- **date-fns** または **Day.js**: 日付操作

#### データストレージ（将来拡張）
- **初期フェーズ**: データストレージなし（リアルタイムスクレイピング）
- **将来的な拡張**:
  - Redis（Render.com Add-ons）またはファイルシステムキャッシュ
  - スクレイピング負荷軽減のためのキャッシュ機構

### アプリケーションアーキテクチャ
- **アーキテクチャパターン**: サーバーサイドレンダリング + API Routes
- **レンダリング戦略**:
  - 検索フォーム: クライアントサイドレンダリング（CSR）
  - 結果表示: サーバーサイドレンダリング（SSR）またはサーバーコンポーネント
- **状態管理**:
  - React Hooks (useState, useEffect)
  - URL Search Params による検索条件の永続化

### データストレージ
- **初期実装**: なし（オンデマンドスクレイピング）
- **将来的なキャッシュ**:
  - Redis（Render.com Add-ons） - 無料枠の範囲内
  - Time-To-Live (TTL) ベースのキャッシュ（1時間程度）

### 外部連携
- **スクレイピング対象**: 宇美町施設予約システム (https://www.11489.jp/Umi/web/Home/WgR_ModeSelect)
- **プロトコル**: HTTP/HTTPS
- **認証**: 不要（公開されている情報のみ取得）
- **Rate Limiting**:
  - リクエスト間隔の制御（最低5秒）
  - 同時リクエスト数の制限（1リクエストのみ）

### 監視とダッシュボード技術
本プロジェクトでは管理用ダッシュボードは不要。
ユーザー向けのシンプルな検索・結果表示UIのみ。

- **UIフレームワーク**: React (Next.js)
- **スタイリング**: TailwindCSS
- **リアルタイム通信**: 不要（静的な検索結果表示）
- **状態管理**: React Hooks

## 開発環境

### ビルド＆開発ツール
- **ビルドシステム**: Next.js内蔵（Turbopack/Webpack）
- **パッケージ管理**: pnpm
- **開発ワークフロー**:
  - `next dev` - ホットリロード付き開発サーバー
  - `next build` - プロダクションビルド
  - `next start` - プロダクションサーバー起動

### コード品質ツール
- **静的解析**: ESLint (Next.js推奨設定)
- **フォーマット**: Prettier
- **型チェック**: TypeScript Compiler (tsc)
- **テストフレームワーク**:
  - Vitest または Jest (ユニットテスト)
  - Playwright (E2Eテスト - 必要に応じて)
- **ドキュメント**: README.md、インラインコメント

### バージョン管理とコラボレーション
- **VCS**: Git
- **ブランチ戦略**: GitHub Flow（シンプルな運用）
  - `main` ブランチ: プロダクション環境
  - フィーチャーブランチ: 機能開発
- **コードレビュープロセス**: 個人プロジェクトのため不要（将来的にPRベース）

## デプロイ＆配布

- **ターゲットプラットフォーム**: Render.com（無料枠）✅ **本番稼働中**
  - **本番URL**: https://umi-facility-reservation.onrender.com
  - **デプロイ完了日**: 2025年12月7日
  - **選定理由**:
    - 無料枠で750時間/月の稼働時間
    - 実行時間制限なし
    - Dockerサポートによる柔軟なChromium環境構築
    - 宇美町システムへのアクセス可能（検証済み）
  - **本番環境での実績**:
    - スクレイピング機能: 正常動作（7日分の施設検索が正常に完了）
    - コールドスタート時間: 約30-60秒（無料プランのスリープ機能による）
- **配布方法**: Web URL経由でアクセス
- **インストール要件**: モダンモバイルブラウザ（iOS Safari 14+, Android Chrome 90+）
- **更新メカニズム**:
  - Render.comへのpush時に自動デプロイ
  - ダウンタイムなしのデプロイ
  - GitHub mainブランチとの自動同期

## 技術要件と制約

### パフォーマンス要件
- **初回表示**: 2秒以内（Lighthouse Performance 90以上目標）
- **検索結果取得**: 30秒以内
  - スクレイピング処理含む（複雑なフローのため時間がかかる）
  - ローディング表示で体感速度を向上
- **モバイル最適化**: Lighthouse Mobile Score 90以上
- **メモリ使用量**: サーバーサイド 512MB以内（Render.com無料枠制限）

### 互換性要件
- **プラットフォームサポート**:
  - iOS Safari 14+
  - Android Chrome 90+
- **依存関係バージョン**:
  - Node.js 20.x
  - Next.js 15.x (最新LTS)
  - pnpm 9.x
  - Puppeteer with @sparticuz/chromium 133.0.0（サーバーレス環境用）
- **標準準拠**: HTML5, CSS3, ES2020+

### セキュリティとコンプライアンス
- **セキュリティ要件**:
  - HTTPS通信（Render.comデフォルト）
  - XSS対策（Reactのデフォルト保護）
  - スクレイピング先への過度な負荷防止
  - ユーザーデータの保存なし（プライバシー配慮）
  - User-Agent標準化（一般的なブラウザとして認識させる）
- **コンプライアンス標準**:
  - 公開情報のスクレイピング（利用規約確認済み前提）
  - 個人情報保護法準拠（ユーザーデータ非保存）
- **脅威モデル**:
  - スクレイピング先システムへのDoS攻撃リスク → Rate Limiting実装
  - スクレイピング先のHTML構造変更 → エラーハンドリングとフォールバック
  - IPアドレスブロッキング → 適切なホスティングプラットフォーム選定

### スケーラビリティと信頼性
- **想定負荷**:
  - 同時ユーザー数: 1-2名程度（チームメンバー限定）
  - リクエスト数: 1日あたり10-20リクエスト未満
- **可用性要件**:
  - Render.com無料枠の範囲内での最大努力
  - 99%アップタイム目標（Render.com依存）
  - コールドスタート対策（最初のリクエストは遅延する可能性あり）
- **成長予測**:
  - 初期フェーズでは成長予測なし
  - 将来的に他チームへの展開可能性あり

## 技術的決定事項と根拠

### 決定ログ

1. **Next.js (App Router) の採用**
   - **理由**:
     - フロントエンドとバックエンドを一つのフレームワークで実装可能
     - サーバーサイドレンダリングによるパフォーマンス最適化
     - API Routesでスクレイピング処理を実装可能
   - **代替案**:
     - Remix: 学習コストと実績を考慮してNext.jsを選択
     - SPA + 別途バックエンド: 開発コストと運用コストが増加

2. **TailwindCSSの採用**
   - **理由**:
     - モバイルファーストなレスポンシブデザインが簡単
     - ユーティリティクラスによる高速な開発
     - バンドルサイズの最適化（未使用CSSの自動削除）
   - **代替案**:
     - CSS Modules: スタイリングの柔軟性とモバイル最適化を優先
     - Styled-components: ビルド時のパフォーマンスを考慮

3. **Puppeteer/Playwrightによるスクレイピング**
   - **理由**:
     - 動的JavaScriptコンテンツの取得が可能
     - セッション管理が容易
     - ブラウザ操作の自動化
   - **代替案**:
     - Cheerio + Axios: 対象サイトが動的レンダリングの可能性があるため不採用
   - **トレードオフ**:
     - 実行コストが高い → 実行時間制限のないホスティング環境を選定

4. **初期フェーズでのキャッシュレス設計**
   - **理由**:
     - 実装の簡素化
     - データベース管理コストの削減
     - リアルタイム性の確保
   - **トレードオフ**:
     - スクレイピング先への負荷増加 → Rate Limitingで緩和
     - レスポンス時間の増加 → ローディング表示で対応
   - **将来的な改善**: Redisによるキャッシュ実装

5. **Render.comでのホスティング**
   - **理由**:
     - Puppeteerに適した環境（実行時間制限なし）
     - 無料枠で750時間/月の稼働時間
     - Dockerサポートによる柔軟な環境構築
     - 宇美町システムへのアクセス可能（検証済み）
     - CI/CD自動化（GitHub連携）
   - **代替案**:
     - Netlify: 実行時間制限が短い（10-26秒）
     - Heroku: 無料枠が廃止（最低$50/月）
     - Fly.io: メモリ制限と安定性を考慮

## 既知の制限事項

### 技術的制約
1. **Render.com無料枠の制限**
   - **制限**: 750時間/月の稼働時間、15分間アクティビティがないとスリープ
   - **影響**: コールドスタート時に初回レスポンスが遅延（30秒程度）
   - **対策**:
     - ユーザーへの待機時間の明示（ローディング表示）
     - 将来的には有料プランへの移行を検討（$7/月で常時稼働）
     - スクレイピング処理の最適化（タイムアウト延長、リトライロジック）

2. **スクレイピング先のHTML構造変更リスク**
   - **制限**: 宇美町システムのHTML構造変更時にスクレイピングが失敗
   - **影響**: アプリケーション全体の機能停止
   - **対策**:
     - エラー検知とユーザーへの通知
     - HTML構造のバージョン検出機能
     - フォールバック表示

3. **同時リクエスト制限**
   - **制限**: スクレイピング先への配慮から同時リクエストは1つのみ
   - **影響**: 複数ユーザーの同時検索時に待機時間が発生
   - **対策**:
     - キューイング機構の実装
     - ユーザーへの待ち時間表示
     - 将来的なキャッシュ機能での緩和

4. **モバイルブラウザの互換性**
   - **制限**: 古いブラウザバージョンではUIが崩れる可能性
   - **影響**: 一部ユーザーの利用困難
   - **対策**:
     - モダンブラウザの使用を推奨
     - Graceful degradation

### 運用上の制約
1. **スクレイピング先システムの利用規約**
   - **制限**: スクレイピングが明示的に禁止される可能性
   - **対策**: 利用規約の定期確認、必要に応じて町への問い合わせ

2. **メンテナンスとモニタリング**
   - **制限**: 個人運用のため24時間監視は困難
   - **対策**: エラー通知機能、定期的な動作確認

## ホスティングプラットフォーム移行の経緯

### 背景

当初、本プロジェクトはVercelでのホスティングを前提として開発を進めていました。Next.jsとの公式統合、シンプルなデプロイフロー、無料枠での十分な機能などが主な選定理由でした。

### 発生した問題

2025年12月7日、Vercel本番環境へのデプロイは成功したものの、スクレイピング対象である宇美町施設予約システムへの接続テストで以下の問題が発覚しました：

- **問題**: `net::ERR_CONNECTION_TIMED_OUT`エラーが発生
- **原因**: VercelのIPアドレスレンジが宇美町施設予約システムのファイアウォールにブロックされていることが判明
- **影響**: スクレイピング機能が完全に動作せず、アプリケーションの主要機能が使用不可

### 試行した対策

以下の対策を試みましたが、すべて失敗しました：

1. リトライロジックの実装 → タイムアウトエラーが継続
2. User-Agentの変更 → 接続改善せず
3. タイムアウト時間の延長 → エラー継続

### Render.comへの移行

Vercelでの運用が不可能と判断し、同日中にRender.comへの移行を決定・実施しました。

**移行理由**:
- 異なるIPアドレスレンジを使用
- 実行時間制限なし（Puppeteerに適した環境）
- 無料枠で750時間/月の稼働時間
- Dockerサポートによる柔軟な環境構築

**移行後の検証結果** (2025年12月7日):
- ✅ 宇美町システムへのアクセス成功
- ✅ 7日分の施設検索が正常に完了
- ✅ IPブロック問題の完全解決を確認

### 結論

**現在の本番環境**: Render.com
**本番URL**: https://umi-facility-reservation.onrender.com
**デプロイ完了日**: 2025年12月7日

Render.comでの運用は安定しており、スクレイピング機能を含むすべての機能が正常に動作しています。IPブロッキング問題により、Vercelは本プロジェクトのホスティングプラットフォームとして不適切であることが実証されました。
