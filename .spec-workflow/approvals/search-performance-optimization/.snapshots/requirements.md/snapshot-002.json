{
  "id": "snapshot_1765176726405_uzlxwjdj0",
  "approvalId": "approval_1765176518355_w7vzxiyai",
  "approvalTitle": "要件定義書 (Requirements) - 検索速度最適化",
  "version": 2,
  "timestamp": "2025-12-08T06:52:06.403Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\n宇美町施設予約検索システムにおいて、現在の検索速度が遅い問題を解決します。特に複数日を検索する場合、2〜3分程度かかっており、ユーザー体験を損なっています。インフラコストをかけずに、以下の3つの最適化を実施することで検索速度を大幅に改善します：\n\n1. **待機時間の最適化**: 固定の待機時間を動的な条件チェックに置き換え\n2. **リソース読み込みの最適化**: 不要なリソース（画像・CSS・フォント）の読み込みをブロック\n3. **プログレス表示の追加**: リアルタイムで処理状況を表示し、体感速度を改善\n\nこれにより、実際の処理時間を短縮すると同時に、ユーザーが待ち時間を感じにくくする仕組みを提供します。\n\n## Alignment with Product Vision\n\n本プロジェクトは宇美町の施設予約情報を簡単に検索できるようにすることを目的としています。検索速度の改善は以下の点でプロダクトビジョンに貢献します：\n\n- **ユーザー体験の向上**: 待ち時間の短縮により、ユーザーがストレスなく施設を検索できる\n- **利用率の向上**: 快適な検索体験により、リピート利用が増加する\n- **コスト効率**: インフラを増強せずにパフォーマンスを改善し、持続可能な運用を実現\n\n## Requirements\n\n### Requirement 1: 待機時間の動的最適化\n\n**User Story:** 開発者として、固定の待機時間を動的な条件チェックに置き換えたい。そうすることで、必要最小限の待機時間で次の処理に進むことができる。\n\n#### Acceptance Criteria\n\n1. WHEN ページ遷移後にDOMの読み込みを待機する THEN システムは `setTimeout(固定時間)` の代わりに `waitForFunction()` を使用して条件が満たされるまで動的に待機する SHALL\n2. WHEN AJAX更新後の待機が必要な場合 THEN システムは実際のDOM更新完了を検知してから次の処理に進む SHALL\n3. WHEN スポーツ種目選択後の待機が必要な場合 THEN システムはチェックボックス要素が表示状態になったことを確認してから次の処理に進む SHALL\n4. IF 動的待機がタイムアウトした場合 THEN システムは適切なエラーメッセージを表示する SHALL\n5. WHEN すべての固定待機時間を動的待機に置き換えた THEN システムは1日あたり2〜4秒、7日検索で14〜28秒の速度改善を実現する SHALL\n\n### Requirement 2: 不要リソースの読み込みブロック\n\n**User Story:** 開発者として、スクレイピング時に不要なリソース（画像・CSS・フォント）の読み込みをブロックしたい。そうすることで、ページ読み込み時間を短縮できる。\n\n#### Acceptance Criteria\n\n1. WHEN Puppeteerでページにアクセスする THEN システムはリクエストインターセプションを有効化する SHALL\n2. WHEN 画像・CSS・フォントのリクエストが発生する THEN システムはそれらのリクエストを中止(abort)する SHALL\n3. WHEN HTML・JavaScript・XHRのリクエストが発生する THEN システムはそれらのリクエストを許可(continue)する SHALL\n4. WHEN リソースブロックを適用した THEN システムはページ遷移ごとに0.5〜1秒の速度改善を実現する SHALL\n5. IF リソースブロックによりページの機能が損なわれた場合 THEN システムは該当リソースタイプをブロック対象から除外する SHALL\n\n### Requirement 3: リアルタイムプログレス表示\n\n**User Story:** ユーザーとして、検索処理中にリアルタイムで進捗状況を確認したい。そうすることで、どの段階の処理が行われているか把握でき、待ち時間を感じにくくなる。\n\n#### Acceptance Criteria\n\n1. WHEN 検索を開始する THEN システムはプログレス表示UIを表示する SHALL\n2. WHEN 各ステップ（施設選択、日付選択、データ取得など）を処理する THEN システムは現在の処理内容をリアルタイムで表示する SHALL\n3. WHEN 複数日を検索する THEN システムは「X/Y日目を処理中...」という形式で進捗を表示する SHALL\n4. WHEN 各日付の処理が完了する THEN システムは進捗バーまたはパーセンテージを更新する SHALL\n5. WHEN すべての処理が完了する THEN システムはプログレス表示を非表示にして結果画面に遷移する SHALL\n6. IF 処理中にエラーが発生した場合 THEN システムはプログレス表示にエラー情報を表示して処理を中断する SHALL\n\n### Requirement 4: 処理ログの詳細化\n\n**User Story:** 開発者として、各処理ステップの所要時間を計測したい。そうすることで、ボトルネックを特定し、さらなる最適化の判断材料にできる。\n\n#### Acceptance Criteria\n\n1. WHEN 各処理ステップを開始する THEN システムは開始時刻を記録する SHALL\n2. WHEN 各処理ステップを完了する THEN システムは所要時間をログに出力する SHALL\n3. WHEN スクレイピング全体が完了する THEN システムは合計所要時間と各ステップの内訳をログに出力する SHALL\n4. WHEN ログを出力する THEN システムは日本語で分かりやすい形式で出力する SHALL\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**: 各最適化機能は独立したメソッドまたはユーティリティとして実装する\n- **Modular Design**: 待機時間最適化、リソースブロック、プログレス表示は独立して有効化/無効化できる設計とする\n- **Dependency Management**: 既存のスクレイピングロジックへの影響を最小限に抑える\n- **Clear Interfaces**: プログレス更新のためのイベント駆動アーキテクチャを採用する\n\n### Performance\n- **待機時間の削減**: 7日検索において14〜28秒の速度改善を達成する\n- **リソース読み込みの削減**: ページ遷移ごとに0.5〜1秒の速度改善を達成する\n- **体感速度の改善**: プログレス表示により、ユーザーが待ち時間を感じにくくする\n\n### Security\n- **スクレイピング制限の遵守**: 既存のレート制限（5秒間隔）を維持する\n- **エラーハンドリング**: 最適化によりエラーが増加しないよう、適切なエラーハンドリングを実装する\n\n### Reliability\n- **後方互換性**: 最適化により既存の機能が損なわれないことを保証する\n- **フォールバック機能**: 動的待機がタイムアウトした場合、適切にエラーを報告する\n- **テスト**: 最適化後も既存のテストが合格することを確認する\n\n### Usability\n- **プログレス表示の明確性**: ユーザーが現在の処理状況を直感的に理解できる\n- **エラーメッセージの改善**: エラーが発生した場合、ユーザーに分かりやすいメッセージを表示する\n- **レスポンシブデザイン**: プログレス表示はモバイルデバイスでも適切に表示される\n",
  "fileStats": {
    "size": 7468,
    "lines": 97,
    "lastModified": "2025-12-08T06:48:31.160Z"
  },
  "comments": []
}